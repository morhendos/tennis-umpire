import { Audio } from 'expo-av';

const API_KEY = process.env.EXPO_PUBLIC_ELEVENLABS_API_KEY || 'sk_a2b846ed395f647e7e693afc417b4ac6be9a94945d292f53';

// British male voice - sounds authoritative like a tennis umpire
// "George" - clear British accent
const VOICE_ID = 'JBFqnCBsd6RMkjVDRZzb';

// Alternative voices to try:
// "Daniel" - British, authoritative: 'onwK4e9ZLuTAKqWW03F9'
// "Charlie" - Australian: 'IKne3meq5aSn9XLyUdCD'

const API_URL = 'https://api.elevenlabs.io/v1/text-to-speech';

// Cache for audio - avoid re-generating same phrases
const audioCache = new Map<string, Audio.Sound>();

// Currently playing sound
let currentSound: Audio.Sound | null = null;

export async function speakWithElevenLabs(text: string): Promise<void> {
  try {
    // Stop any currently playing audio
    if (currentSound) {
      await currentSound.stopAsync();
      await currentSound.unloadAsync();
      currentSound = null;
    }

    // Check cache first
    const cacheKey = text.toLowerCase().trim();
    if (audioCache.has(cacheKey)) {
      const cachedSound = audioCache.get(cacheKey)!;
      await cachedSound.replayAsync();
      currentSound = cachedSound;
      return;
    }

    // Call ElevenLabs API
    const response = await fetch(`${API_URL}/${VOICE_ID}`, {
      method: 'POST',
      headers: {
        'Accept': 'audio/mpeg',
        'Content-Type': 'application/json',
        'xi-api-key': API_KEY,
      },
      body: JSON.stringify({
        text,
        model_id: 'eleven_multilingual_v2',
        voice_settings: {
          stability: 0.75,
          similarity_boost: 0.75,
          style: 0.5,
          use_speaker_boost: true,
        },
      }),
    });

    if (!response.ok) {
      throw new Error(`ElevenLabs API error: ${response.status}`);
    }

    // Get audio data
    const audioBlob = await response.blob();
    const audioUri = URL.createObjectURL(audioBlob);

    // For React Native, we need to convert blob to base64
    const reader = new FileReader();
    const base64Promise = new Promise<string>((resolve, reject) => {
      reader.onload = () => {
        const base64 = reader.result as string;
        resolve(base64);
      };
      reader.onerror = reject;
    });
    reader.readAsDataURL(audioBlob);
    const base64Audio = await base64Promise;

    // Create and play sound
    const { sound } = await Audio.Sound.createAsync(
      { uri: base64Audio },
      { shouldPlay: true }
    );

    currentSound = sound;

    // Cache for future use (limit cache size)
    if (audioCache.size < 100) {
      audioCache.set(cacheKey, sound);
    }

    // Clean up when done
    sound.setOnPlaybackStatusUpdate((status) => {
      if (status.isLoaded && status.didJustFinish) {
        // Don't unload if cached
        if (!audioCache.has(cacheKey)) {
          sound.unloadAsync();
        }
      }
    });
  } catch (error) {
    console.error('ElevenLabs TTS error:', error);
    // Fall back to native TTS
    const Speech = require('expo-speech');
    Speech.speak(text, { language: 'en-GB', rate: 0.9 });
  }
}

// Stop any current speech
export async function stopSpeech(): Promise<void> {
  if (currentSound) {
    await currentSound.stopAsync();
  }
}

// Clear the audio cache
export function clearCache(): void {
  audioCache.forEach((sound) => {
    sound.unloadAsync();
  });
  audioCache.clear();
}

// Pre-generate common tennis phrases to cache them
export async function preloadCommonPhrases(): Promise<void> {
  const commonPhrases = [
    'Love all',
    'Fifteen love',
    'Fifteen all',
    'Thirty love',
    'Thirty fifteen',
    'Thirty all',
    'Forty love',
    'Forty fifteen',
    'Forty thirty',
    'Deuce',
    'Advantage',
    'Game',
  ];

  // Don't await - let them load in background
  for (const phrase of commonPhrases) {
    speakWithElevenLabs(phrase).catch(() => {});
    // Small delay to not overwhelm the API
    await new Promise((resolve) => setTimeout(resolve, 500));
  }
}
